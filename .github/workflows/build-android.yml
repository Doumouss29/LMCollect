name: Build LM Collect (Android)

on:
  workflow_dispatch:      # Ex√©cutable manuellement
  push:
    branches: ["rebrand/lm-collect"]   # ou la branche de ton choix

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1Ô∏è‚É£ R√©cup√©rer tout le d√©p√¥t + le sous-module QField
      - name: Checkout (LMCollect + sous-modules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2Ô∏è‚É£ D√©finir les infos de version
      - name: D√©finir les versions/app infos
        run: |
          echo "APP_VERSION=$(date +%Y.%m.%d)" >> $GITHUB_ENV
          echo "APP_VERSION_CODE=$(( $(date +%s) / 60 ))" >> $GITHUB_ENV
          echo "PKG_ID=com.doumouss29.lmcollect" >> $GITHUB_ENV
          echo "APP_NAME=LM Collect" >> $GITHUB_ENV

      # 3Ô∏è‚É£ G√©n√©rer les ic√¥nes Android
      - name: G√©n√©rer ic√¥nes Android
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          mkdir -p platform/android/app/src/main/res
          for d in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            mkdir -p platform/android/app/src/main/res/$d
          done
          declare -A S=( [mipmap-mdpi]=48 [mipmap-hdpi]=72 [mipmap-xhdpi]=96 [mipmap-xxhdpi]=144 [mipmap-xxxhdpi]=192 )
          for dir in "${!S[@]}"; do
            convert "branding/lmcollect/appicon_source.jpeg" \
              -resize ${S[$dir]}x${S[$dir]}^ -gravity center -extent ${S[$dir]}x${S[$dir]} \
              "platform/android/app/src/main/res/$dir/ic_launcher.png"
          done

      # 4Ô∏è‚É£ √âcran splash
      - name: Splash (fond bleu)
        run: |
          mkdir -p platform/android/app/src/main/res/drawable platform/android/app/src/main/res/values
          cat > platform/android/app/src/main/res/drawable/splash_background.xml <<'XML'
          <?xml version="1.0" encoding="utf-8"?>
          <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
            <item android:drawable="@color/splash_color"/>
          </layer-list>
          XML
          cat > platform/android/app/src/main/res/values/colors.xml <<'XML'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
            <color name="splash_color">#1E88E5</color>
          </resources>
          XML

      # 5Ô∏è‚É£ Build Android avec le SDK officiel QField
      #    üëâ Pas de CMake/Ninja manuels : le wrapper s‚Äôoccupe de tout (Qt6 inclus)
      - name: Build Android avec QField SDK
        run: |
          set -euo pipefail
          docker pull opengisch/qfield-sdk:latest
          docker run --rm -i \
            -v "$PWD":/usr/src/qfield \
            -e APP_VERSION -e APP_VERSION_CODE \
            -e PKG_ID -e APP_NAME \
            opengisch/qfield-sdk:latest \
            /usr/src/qfield/scripts/docker-build-wrapper.sh

      # 6Ô∏è‚É£ Trouver l‚ÄôAPK produit
      - name: Trouver l‚ÄôAPK produit
        id: apk
        run: |
          APK=$(find . -type f -name "*.apk" | head -n1 || true)
          echo "apk=$APK" >> "$GITHUB_OUTPUT"
          test -n "$APK" || { echo "Aucun APK trouv√©"; exit 1; }

      # 7Ô∏è‚É£ (Optionnel) D√©coder le keystore Android
      - name: D√©coder le keystore
        if: ${{ steps.apk.outputs.apk }}
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks

      # 8Ô∏è‚É£ (Optionnel) Signer & Aligner l‚ÄôAPK
      - name: Signer & Aligner l‚ÄôAPK
        if: ${{ steps.apk.outputs.apk }}
        run: |
          sudo apt-get update && sudo apt-get install -y zipalign apksigner
          zipalign -p 4 "${{ steps.apk.outputs.apk }}" lmcollect-aligned.apk
          apksigner sign \
            --ks keystore.jks \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out lmcollect-signed.apk lmcollect-aligned.apk

      # 9Ô∏è‚É£ Publier l‚ÄôAPK sign√© en artefact
      - name: Publier l‚ÄôAPK sign√©
        uses: actions/upload-artifact@v4
        with:
          name: lm-collect-apk
          path: lmcollect-signed.apk
